<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue 聊天应用</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .message { margin: 10px 0; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    .public { background-color: #f0f8ff; }
    .private { background-color: #fff0f5; }
    .input-area { margin-top: 20px; }
    button { margin-left: 10px; padding: 5px 10px; }
    .user-info { margin-bottom: 20px; padding: 10px; background-color: #e9e9e9; border-radius: 4px; }
    .login-form input { margin-right: 10px; }
  </style>
</head>
<body>
  <div id="app">
    <h1>聊天室</h1>
    
    <div class="input-area login-form" v-if="!isLoggedIn">
      <input v-model="nickname" placeholder="你的昵称">
      <input v-model="password" type="password" placeholder="密码">
      <button @click="login">登录</button>
    </div>
    
    <div v-if="isLoggedIn" class="user-info">
      <p>已登录为: <strong>{{ nickname }}</strong> (ID: {{ socketId }})</p>
    </div>
    
    <div v-if="isLoggedIn">
      <div class="input-area">
        <input v-model="publicMessage" placeholder="输入公共消息" @keyup.enter="sendPublicMessage">
        <button @click="sendPublicMessage">发送</button>
      </div>
      
      <div class="input-area">
        <input v-model="privateRecipient" placeholder="接收者ID">
        <input v-model="privateMessage" placeholder="输入私信" @keyup.enter="sendPrivateMessage">
        <button @click="sendPrivateMessage">发送私信</button>
      </div>
      
      <h2>公共消息</h2>
      <div v-for="(msg, index) in publicMessages" :key="'public-'+index" class="message public">
        <strong>{{ msg.sender }} </strong>: {{ msg.text }}
        <small>{{ msg.timestamp }}</small>
      </div>
      
      <h2>私信</h2>
      <div v-for="thread in privateThreads" :key="'thread-'+thread.withUser" class="message private">
        <h3>与 {{ thread.withUser }} 的对话</h3>
        <div v-for="msg in thread.messages" :key="'private-'+msg.id">
          <strong>{{ msg.sender }} </strong>: {{ msg.text }}
          <small>{{ msg.timestamp }}</small>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { ref, onMounted, onUnmounted, createApp } = Vue;
    
    createApp({
      setup() {
        // 响应式数据
        const nickname = ref('');
        const password = ref('');
        const isLoggedIn = ref(false);
        const socket = ref(null);
        const socketId = ref(null);
        
        // 消息相关
        const publicMessage = ref('');
        const publicMessages = ref([]);
        
        const privateRecipient = ref('');
        const privateMessage = ref('');
        const privateThreads = ref([]); // 改为threads，存储与不同用户的对话
        
        // 登录
        const login = () => {
          if (!nickname.value.trim()) {
            alert('请输入昵称');
            return;
          }
          
          if (!password.value.trim()) {
            alert('请输入密码');
            return;
          }
          
          // 初始化WebSocket连接
          socket.value = new WebSocket('wss://5508bee3f64e.ngrok-free.app/ws');
          
          socket.value.onopen = () => {
            console.log('WebSocket 连接成功');
            // 发送登录请求
            socket.value.send(JSON.stringify({
              type: 'login',
              nickname: nickname.value,
              password: password.value
            }));
          };
          
          socket.value.onmessage = (event) => {
            try {
              const message = JSON.parse(event.data);
              console.log(message);
              // 登录响应
              if (message.type === 'login_response') {
                if (message.success) {
                  isLoggedIn.value = true;
                  socketId.value = message.socketId;
                  console.log('登录成功，socketID:', socketId.value);
                } else {
                  alert('登录失败: ' + (message.message || '昵称或密码错误'));
                }
              }
              // 公共消息
              else if (message.type === 'public_message') {
                publicMessages.value.push({
                  sender: message.sender,
                  socketId: message.socketId,
                  text: message.text,
                  timestamp: new Date().toLocaleTimeString()
                });
              }
              // 私信
              else if (message.type === 'private_message') {
                // 检查这条消息是否是发给当前用户的（通过socketId）
                if (message.recipientId === socketId.value) {
                  // 确保privateThreads是数组
                  if (!Array.isArray(privateThreads.value)) {
                    privateThreads.value = [];
                  }
                  
                  // 对话的另一方是消息的发送者
                  const otherUser = message.senderId;
                  const otherNickname = message.sender; // 服务器应该发送发送者的昵称
                  
                  // 查找或创建对话线程
                  const existingThread = privateThreads.value.find(
                    thread => thread.withUser === otherUser
                  );
                  
                  const newMsg = {
                    id: Date.now(),
                    sender: message.sender,
                    senderId: message.senderId,
                    text: message.text,
                    timestamp: new Date().toLocaleTimeString()
                  };
                  
                  if (existingThread) {
                    existingThread.messages.push(newMsg);
                  } else {
                    privateThreads.value.push({
                      withUser: otherUser,
                      withNickname: otherNickname,
                      messages: [newMsg]
                    });
                  }
                }
              }
            } catch (error) {
              console.error('处理消息时出错:', error);
            }
          };
          
          socket.value.onerror = (error) => {
            console.error('WebSocket 错误:', error);
          };
          
          socket.value.onclose = () => {
            console.log('WebSocket 连接关闭');
            isLoggedIn.value = false;
          };
        };
        
        // 发送公共消息
        const sendPublicMessage = () => {
          if (!publicMessage.value.trim() || !isLoggedIn.value) return;
          
          if (socket.value && socket.value.readyState === WebSocket.OPEN) {
            socket.value.send(JSON.stringify({
              type: 'public_message',
              sender: nickname.value,
              socketId: socketId.value,
              text: publicMessage.value
            }));
            
            publicMessage.value = '';
          } else {
            alert('连接未就绪');
          }
        };
        
        // 发送私信
        const sendPrivateMessage = () => {
          if (!privateMessage.value.trim() || 
              !privateRecipient.value.trim() || 
              !isLoggedIn.value) return;
           const recipientId = parseInt(privateRecipient.value.trim());
          if (socket.value && socket.value.readyState === WebSocket.OPEN) {
            socket.value.send(JSON.stringify({
              type: 'private_message',
              sender: nickname.value,
              senderId: socketId.value,
              recipientId: recipientId, // 使用ID而不是昵称
              text: privateMessage.value
            }));
            
            // 添加到自己的私信列表
            if (!Array.isArray(privateThreads.value)) {
              privateThreads.value = [];
            }
            
            // 查找或创建对话线程（以接收者ID为标识）
            const existingThread = privateThreads.value.find(
              thread => thread.withUser === privateRecipient.value
            );
            
            const newMsg = {
              id: Date.now(),
              sender: nickname.value,
              senderId: socketId.value,
              text: privateMessage.value,
              timestamp: new Date().toLocaleTimeString()
            };
            
            if (existingThread) {
              existingThread.messages.push(newMsg);
            } else {
              // 这里我们不知道接收者的昵称，可以留空或从服务器获取
              privateThreads.value.push({
                withUser: privateRecipient.value,
                withNickname: '未知用户', // 最好从服务器获取接收者昵称
                messages: [newMsg]
              });
            }
            
            privateMessage.value = '';
          } else {
            alert('连接未就绪');
          }
        };
        
        // 组件卸载时关闭连接
        onUnmounted(() => {
          if (socket.value) {
            socket.value.close();
          }
        });
        
        return {
          nickname,
          password,
          isLoggedIn,
          socketId,
          publicMessage,
          publicMessages,
          privateRecipient,
          privateMessage,
          privateThreads,
          login,
          sendPublicMessage,
          sendPrivateMessage
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
